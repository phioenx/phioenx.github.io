<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>哈基鹏的大模型之旅（七） | 哈基鹏的博客🐦</title><meta name="author" content="PhoenixPeng"><meta name="copyright" content="PhoenixPeng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="大模型RAG原理与实战，包括如何构建知识库。">
<meta property="og:type" content="article">
<meta property="og:title" content="哈基鹏的大模型之旅（七）">
<meta property="og:url" content="https://amadeuspjq.cn/posts/c976db60.html">
<meta property="og:site_name" content="哈基鹏的博客🐦">
<meta property="og:description" content="大模型RAG原理与实战，包括如何构建知识库。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://amadeuspjq.cn/img/cover11.png">
<meta property="article:published_time" content="2025-12-22T01:38:46.000Z">
<meta property="article:modified_time" content="2025-12-25T01:59:31.763Z">
<meta property="article:author" content="PhoenixPeng">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://amadeuspjq.cn/img/cover11.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "哈基鹏的大模型之旅（七）",
  "url": "https://amadeuspjq.cn/posts/c976db60.html",
  "image": "https://amadeuspjq.cn/img/cover11.png",
  "datePublished": "2025-12-22T01:38:46.000Z",
  "dateModified": "2025-12-25T01:59:31.763Z",
  "author": [
    {
      "@type": "Person",
      "name": "PhoenixPeng",
      "url": "https://amadeuspjq.cn"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://amadeuspjq.cn/posts/c976db60.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '哈基鹏的大模型之旅（七）',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href=" /css/custom.css"><link rel="stylesheet" href=" /css/categorybar.css"><link rel="stylesheet" href=" /css/readPercent.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="/css/categorybar.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 8.1.0"></head><body><div id="web_bg" style="background-image: url(https://amadeuspjq.cn/img/background1.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/cover11.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">哈基鹏的博客🐦</span></a><a class="nav-page-title" href="/"><span class="site-name">哈基鹏的大模型之旅（七）</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">哈基鹏的大模型之旅（七）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-22T01:38:46.000Z" title="发表于 2025-12-22 09:38:46">2025-12-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-25T01:59:31.763Z" title="更新于 2025-12-25 09:59:31">2025-12-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/LLM/">LLM</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">16.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>57分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img gist" style="background-image: url(/img/cover11.png)"></div><article class="container post-content" id="article-container"><h1 id="RAG的基本原理"><a href="#RAG的基本原理" class="headerlink" title="RAG的基本原理"></a>RAG的基本原理</h1><p><font color = black size = 4>大语言模型（LLM）在生成内容时，虽然具备强大的语言理解和生成能力，但也面临着一些挑战。例如，LLM有时会生成不准确或误导性的内容，这被称为大模型“幻觉”。此外，模型所依赖的训练数据可能过时，尤其在面对最新的信息时，生成结果的准确性和时效性难以保证。对于特定领域的专业知识，LLM 的处理效率也较低，无法深入理解复杂的领域知识。因此，如何提升大模型的生成质量和效率，成为了当前研究的重要方向。</font></p>
<p><font color = black size = 4>在这样的背景下， <strong>检索增强生成（Retrieval-Augmented Generation，RAG）</strong> 技术应运而生，成为AI领域中的一大创新趋势。从本质上讲，RAG（Retrieval-Augmented Generation）是一种旨在解决大语言模型（LLM）“知其然不知其所以然”问题的技术范式。它的核心是将模型内部学到的“<strong>参数化知识</strong>”（模型权重中固化的、模糊的“记忆”），与来自外部知识库的“<strong>非参数化知识</strong>”（精准、可随时更新的外部数据）相结合。其运作逻辑就是在 LLM 生成文本前，先通过检索机制从外部知识库中动态获取相关信息，并将这些“参考资料”融入生成过程，从而提升输出的准确性和时效性 。</font></p>
<p><font color = black size = 4>那么，RAG 系统是如何实现“参数化知识”与“非参数化知识”的结合呢？如图 1-1 所示，其架构主要通过两个阶段来完成这一过程：</font></p>
<ol>
<li><font color = black size = 4><strong>检索阶段：寻找“非参数化知识”</strong></font><ul>
<li><font color = black size = 4><strong>知识向量化</strong>：<strong>嵌入模型（Embedding Model）</strong> 充当了“连接器”的角色。它将外部知识库编码为向量索引（Index），存入<strong>向量数据库</strong>。</font></li>
<li><font color = black size = 4><strong>语义召回</strong>：当用户发起查询时，检索模块利用同样的嵌入模型将问题向量化，并通过<strong>相似度搜索（Similarity Search）</strong>，从海量数据中精准锁定与问题最相关的文档片段。</font></li>
</ul>
</li>
<li><font color = black size = 4><strong>生成阶段：融合两种知识</strong></font><ul>
<li><font color = black size = 4><strong>上下文整合</strong>：<strong>生成模块</strong>接收检索阶段送来的相关文档片段以及用户的原始问题。</font></li>
<li><font color = black size = 4><strong>指令引导生成</strong>：该模块会遵循预设的 <strong>Prompt</strong> 指令，将上下文与问题有效整合，并引导 LLM（如 DeepSeek）进行可控的、有理有据的文本生成。</font></li>
</ul>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/phioenx/blog-img/main/blog-img/1_1_1.svg"></p>
<h1 id="搭建向量知识库"><a href="#搭建向量知识库" class="headerlink" title="搭建向量知识库"></a>搭建向量知识库</h1><h2 id="向量及向量知识库"><a href="#向量及向量知识库" class="headerlink" title="向量及向量知识库"></a>向量及向量知识库</h2><p><font color = black size = 4>在机器学习和自然语言处理（NLP）中，{ % span red，词向量（word embedding）%} 是一种以单词为单位将每个单词转化为实数向量的技术。这些实数向量可以被计算机更好地理解和处理。{ % span red，词向量 %}背后的主要想理念是相似或相关的对象在向量空间中的距离应该很近。</font></p>
<p><img src="https://raw.githubusercontent.com/phioenx/blog-img/main/blog-img/C3-1-embedding.png"></p>
<p><font color = black size = 4>例如，我们可以使用词向量来表示文本数据。在词向量中，每个单词被转换为一个向量，这个向量捕获了这个单词的语义信息。例如，”king” 和 “queen” 这两个单词在向量空间中的位置将会非常接近，因为它们的含义相似。而 “apple” 和 “orange” 也会很接近，因为它们都是水果。而 “king” 和 “apple” 这两个单词在向量空间中的距离就会比较远，因为它们的含义不同。</font></p>
<p><img src="https://raw.githubusercontent.com/phioenx/blog-img/main/blog-img/C3-2-similar.png"></p>
<p><font color = black size = 4>词向量实际上是将单词转化为固定的静态的向量，虽然可以在一定程度上捕捉并表达文本中的语义信息，但忽略了单词在不同语境中的意思会受到影响这一现实。因此在RAG应用中使用的向量技术一般为通用文本向量(Universal text embedding)，该技术可以对一定范围内任意长度的文本进行向量化，与词向量不同的是向量化的单位不再是单词而是输入的文本，输出的向量会捕捉更多的语义信息。</font></p>
<p><font color = black size = 4>在 <strong>RAG（Retrieval Augmented Generation，检索增强生成）</strong> 方面向量的优势主要有两点：</font></p>
<ul>
<li><font color = black size = 4>向量比文字更适合检索。当我们在数据库检索时，如果数据库存储的是文字，主要通过检索关键词（词法搜索）等方法找到相对匹配的数据，匹配的程度取决于数据库中的文档中是否含有查询句中的关键词；而向量中包含了原文本的语义信息，可以通过计算问题与数据库中数据的点积、余弦距离、欧几里得距离等指标，直接获取问题与数据在语义层面上的相似度；</font></li>
<li><font color = black size = 4>向量比其它媒介的综合信息能力更强，当传统数据库存储文字、声音、图像、视频等多种媒介时，很难去将上述多种媒介构建起关联与跨模态的查询方法；但是向量却可以通过多种向量模型将多种数据映射成统一的向量形式。</font></li>
</ul>
<p><font color = black size = 4>在搭建RAG系统时，我们往往可以通过向量模型来构建向量，我们可以选择：</font></p>
<ul>
<li><font color = black size = 4>使用各个公司的 Embedding API</font></li>
<li><font color = black size = 4>在本地使用向量模型将数据构建为向量</font></li>
</ul>
<p><font color = black size = 4><span class='p blue'>向量数据库</span>是用于高效计算和管理大量向量数据的解决方案。<span class='p blue'>向量数据库</span>是一种专门用于存储和检索向量数据（embedding）的数据库系统。它与传统的基于关系模型的数据库不同，它主要关注的是向量数据的特性和相似性。</font></p>
<p><font color = black size = 4>在<span class='p blue'>向量数据库</span>中，数据被表示为向量形式，每个向量代表一个数据项。这些向量可以是数字、文本、图像或其他类型的数据。向量数据库使用高效的索引和查询算法来加速向量数据的存储和检索过程。</font></p>
<p><font color = black size = 4><span class='p blue'>向量数据库</span>中的数据以向量作为基本单位，对向量进行存储、处理及检索。向量数据库通过计算与目标向量的余弦距离、点积等获取与目标向量的相似度。当处理大量甚至海量的向量数据时，向量数据库索引和查询算法的效率明显高于传统数据库。</font></p>
<ul>
<li><font color = black size = 4><a target="_blank" rel="noopener" href="https://www.trychroma.com/">Chroma</a>：是一个轻量级向量数据库，拥有丰富的功能和简单的API，具有简单、易用、轻量的优点，但功能相对简单且不支持GPU加速，适合初学者使用。</font></li>
<li><font color = black size = 4><a target="_blank" rel="noopener" href="https://weaviate.io/">Weaviate</a>：是一个开源向量数据库。除了支持相似度搜索和最大边际相关性（MMR，Maximal Marginal Relevance）搜索外还可以支持结合多种搜索算法（基于词法搜索、向量搜索）的混合搜索，从而提高搜索结果的相关性和准确性。</font></li>
<li><font color = black size = 4><a target="_blank" rel="noopener" href="https://qdrant.tech/">Qdrant</a>：Qdrant使用 Rust 语言开发，有极高的检索效率和RPS（Requests Per Second），支持本地运行、部署在本地服务器及Qdrant云三种部署模式。且可以通过为页面内容和元数据制定不同的键来复用数据。</font></li>
</ul>
<h2 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h2><p><font color = black size = 4>在RAG系统中，<strong>数据加载</strong>是整个流水线的第一步，也是不可或缺的一步。文档加载器负责将各种格式的非结构化文档（如PDF、Word、Markdown、HTML等）转换为程序可以处理的结构化数据。数据加载的质量会直接影响后续的索引构建、检索效果和最终的生成质量。</font></p>
<p><font color = black size = 4><strong>文档加载器的主要功能：</strong></font></p>
<ul>
<li><font color = black size = 4><strong>文档格式解析</strong> 将不同格式的文档（如PDF、Word、Markdown等）解析为文本内容。</font></li>
<li><font color = black size = 4><strong>元数据提取</strong> 在解析文档内容的同时，提取相关的元数据信息，如文档来源、页码等。</font></li>
<li><font color = black size = 4><strong>统一数据格式</strong> 将解析后的内容转换为统一的数据格式，便于后续处理。</font></li>
</ul>
<p><font color = black size = 4>当前主流RAG文档加载器：</font></p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>特点</th>
<th>适用场景</th>
<th>性能表现</th>
</tr>
</thead>
<tbody><tr>
<td><strong>PyMuPDF4LLM</strong></td>
<td>PDF→Markdown转换，OCR+表格识别</td>
<td>科研文献、技术手册</td>
<td>开源免费，GPU加速</td>
</tr>
<tr>
<td><strong>TextLoader</strong></td>
<td>基础文本文件加载</td>
<td>纯文本处理</td>
<td>轻量高效</td>
</tr>
<tr>
<td><strong>DirectoryLoader</strong></td>
<td>批量目录文件处理</td>
<td>混合格式文档库</td>
<td>支持多格式扩展</td>
</tr>
<tr>
<td><strong>Unstructured</strong></td>
<td>多格式文档解析</td>
<td>PDF、Word、HTML等</td>
<td>统一接口，智能解析</td>
</tr>
<tr>
<td><strong>FireCrawlLoader</strong></td>
<td>网页内容抓取</td>
<td>在线文档、新闻</td>
<td>实时内容获取</td>
</tr>
<tr>
<td><strong>LlamaParse</strong></td>
<td>深度PDF结构解析</td>
<td>法律合同、学术论文</td>
<td>解析精度高，商业API</td>
</tr>
<tr>
<td><strong>Docling</strong></td>
<td>模块化企业级解析</td>
<td>企业合同、报告</td>
<td>IBM生态兼容</td>
</tr>
<tr>
<td><strong>Marker</strong></td>
<td>PDF→Markdown，GPU加速</td>
<td>科研文献、书籍</td>
<td>专注PDF转换</td>
</tr>
<tr>
<td><strong>MinerU</strong></td>
<td>多模态集成解析</td>
<td>学术文献、财务报表</td>
<td>集成LayoutLMv3+YOLOv8</td>
</tr>
</tbody></table>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4>为构建我们的本地知识库，我们需要对以多种类型存储的本地文档进行处理，读取本地文档并通过前文描述的 Embedding 方法将本地文档的内容转化为词向量来构建向量数据库。在本节中，我们以一些实际示例入手，来讲解如何对本地文档进行处理。</font></p>
<p><font color = black size = 4>我们选用 Datawhale 一些经典开源课程作为示例，具体包括：</font></p>
<ul>
<li><font color = black size = 4><a target="_blank" rel="noopener" href="https://github.com/datawhalechina/pumpkin-book/releases">《机器学习公式详解》PDF版本</a></font></li>
<li><font color = black size = 4><a target="_blank" rel="noopener" href="https://github.com/datawhalechina/llm-cookbook">《面向开发者的LLM入门教程、第一部分Prompt Engineering》md版本</a></font></li>
</ul>
<p><font color = black size = 4>对应PDF文档，我们可以使用 LangChain 的 PyMuPDFLoader 来读取知识库的 PDF 文件。 PyMuPDFLoader 是 PDF 解析器中速度最快的一种，结果会包含 PDF 及其页面的详细元数据，并且每页返回一个文档。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> PyMuPDFLoader</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个 PyMuPDFLoader Class 实例，输入为待加载的 pdf 文档路径</span></span><br><span class="line">loader = PyMuPDFLoader(<span class="string">&quot;D:\Amadeus\Zeztz-demo1\datas\knowledge_db\pumpkin_book.pdf&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用 PyMuPDFLoader Class 的函数 load 对 pdf 文件进行加载</span></span><br><span class="line">pdf_pages = loader.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;载入后的变量类型为：<span class="subst">&#123;<span class="built_in">type</span>(pdf_pages)&#125;</span>，&quot;</span>,  <span class="string">f&quot;该 PDF 一共包含 <span class="subst">&#123;<span class="built_in">len</span>(pdf_pages)&#125;</span> 页&quot;</span>)</span><br><span class="line">——————————————————————————————————————————————————————————————————————————————————————————————————————</span><br><span class="line">ouput:载入后的变量类型为：&lt;<span class="keyword">class</span> <span class="string">&#x27;list&#x27;</span>&gt;， 该 PDF 一共包含 <span class="number">196</span> 页</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>文档加载后储存在<code>pdf_pages</code>变量当中：</font></p>
<p><font color = black size = 4><code>pdf_pages</code>的变量类型为list，list当中的每一个元素为一个文档，该元素变量包含两个属性：</font></p>
<ul>
<li><font color = black size = 4><code>pdf_pages.meta_data</code>为文档相关的描述性数据</font></li>
<li><font color = black size = 4><code>pdf_pages.page_content</code>包含该文档的内容</font></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;每一个元素的类型：<span class="subst">&#123;<span class="built_in">type</span>(pdf_page)&#125;</span>.&quot;</span>, </span><br><span class="line">    <span class="string">f&quot;该文档的描述性数据：<span class="subst">&#123;pdf_page.metadata&#125;</span>&quot;</span>, </span><br><span class="line">    <span class="string">f&quot;查看该文档的内容:\n<span class="subst">&#123;pdf_page.page_content&#125;</span>&quot;</span>, </span><br><span class="line">    sep=<span class="string">&quot;\n------\n&quot;</span>)</span><br><span class="line">----------------------------------------------------------------------------------------------------------</span><br><span class="line">每一个元素的类型：&lt;<span class="keyword">class</span> <span class="string">&#x27;langchain_core.documents.base.Document&#x27;</span>&gt;.</span><br><span class="line">------</span><br><span class="line">该文档的描述性数据：&#123;<span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;xdvipdfmx (20200315)&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;LaTeX with hyperref&#x27;</span>, <span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;2023-11-17T15:20:45+00:00&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\pumpkin_book.pdf&#x27;</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\pumpkin_book.pdf&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">196</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.5&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&quot;D:20231117152045-00&#x27;00&#x27;&quot;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">1</span>&#125;</span><br><span class="line">------</span><br><span class="line">查看该文档的内容:</span><br><span class="line">前言</span><br><span class="line">“周志华老师的《机器学习》（西瓜书）是机器学习领域的经典入门教材之一，周老师为了使尽可</span><br><span class="line">能多的读</span><br><span class="line">者通过西瓜书对机器学习有所了解, 所以在书中对部分公式的推导细节没有详述，但是这对那些 </span><br><span class="line">想深究公式推</span><br><span class="line">导细节的读者来说可能“不太友好”，本书旨在对西瓜书里比较难理解的公式加以解析，以及对部 </span><br><span class="line">分公式补充</span><br><span class="line">具体的推导细节。”</span><br><span class="line">读到这里，大家可能会疑问为啥前面这段话加了引号，因为这只是我们最初的遐想，后来我们了 </span><br><span class="line">解到，周</span><br><span class="line">老师之所以省去这些推导细节的真实原因是，他本尊认为“理工科数学基础扎实点的大二下学生应</span><br><span class="line">该对西瓜书</span><br><span class="line">中的推导细节无困难吧，要点在书里都有了，略去的细节应能脑补或做练习”。所以...... 本南 </span><br><span class="line">瓜书只能算是我</span><br><span class="line">等数学渣渣在自学的时候记下来的笔记，希望能够帮助大家都成为一名合格的“理工科数学基础扎</span><br><span class="line">实点的大二</span><br><span class="line">下学生”。</span><br><span class="line">使用说明</span><br><span class="line">• 南瓜书的所有内容都是以西瓜书的内容为前置知识进行表述的，所以南瓜书的最佳使用方法是 </span><br><span class="line">以西瓜书</span><br><span class="line">为主线，遇到自己推导不出来或者看不懂的公式时再来查阅南瓜书；</span><br><span class="line">• 对于初学机器学习的小白，西瓜书第<span class="number">1</span> 章和第<span class="number">2</span> 章的公式强烈不建议深究，简单过一下即可， </span><br><span class="line">等你学得</span><br><span class="line">有点飘的时候再回来啃都来得及；</span><br><span class="line">• 每个公式的解析和推导我们都力(zhi) 争(neng) 以本科数学基础的视角进行讲解，所以超纲的</span><br><span class="line">数学知识</span><br><span class="line">我们通常都会以附录和参考文献的形式给出，感兴趣的同学可以继续沿着我们给的资料进行深入 </span><br><span class="line">学习；</span><br><span class="line">• 若南瓜书里没有你想要查阅的公式，或者你发现南瓜书哪个地方有错误，请毫不犹豫地去我们GitHub 的</span><br><span class="line">Issues（地址：https://github.com/datawhalechina/pumpkin-book/issues）进行反馈，在对应</span><br><span class="line">版块</span><br><span class="line">提交你希望补充的公式编号或者勘误信息，我们通常会在<span class="number">24</span> 小时以内给您回复，超过<span class="number">24</span> 小时未 </span><br><span class="line">回复的</span><br><span class="line">话可以微信联系我们（微信号：at-Sm1les）；</span><br><span class="line">配套视频教程：https://www.bilibili.com/video/BV1Mh411e7VU</span><br><span class="line">在线阅读地址：https://datawhalechina.github.io/pumpkin-book（仅供第<span class="number">1</span> 版）</span><br><span class="line">最新版PDF 获取地址：https://github.com/datawhalechina/pumpkin-book/releases</span><br><span class="line">编委会</span><br><span class="line">主编：Sm1les、archwalker、jbb0523</span><br><span class="line">编委：juxiao、Majingmin、MrBigFan、shanry、Ye980226</span><br><span class="line">封面设计：构思-Sm1les、创作-林王茂盛</span><br><span class="line">致谢</span><br><span class="line">特别感谢awyd234、feijuan、Ggmatch、Heitao5200、huaqing89、LongJH、LilRachel、LeoLRH、</span><br><span class="line">Nono17、</span><br><span class="line">spareribs、sunchaothu、StevenLzq 在最早期的时候对南瓜书所做的贡献。</span><br><span class="line">扫描下方二维码，然后回复关键词“南瓜书”，即可加入“南瓜书读者交流群”</span><br><span class="line">版权声明</span><br><span class="line">本作品采用知识共享署名-非商业性使用-相同方式共享<span class="number">4.0</span> 国际许可协议进行许可。</span><br></pre></td></tr></table></figure>



<h2 id="数据清洗"><a href="#数据清洗" class="headerlink" title="数据清洗"></a>数据清洗</h2><p><font color = black size = 4>我们期望知识库的数据尽量是有序的、优质的、精简的，因此我们要删除低质量的、甚至影响理解的文本数据。<br>可以看到上文中读取的pdf文件不仅将一句话按照原文的分行添加了换行符<code>\n</code>，也在原本两个符号中间插入了<code>\n</code>，我们可以使用正则表达式匹配并删除掉<code>\n</code>。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pdf_page.page_content = pdf_page.page_content.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">-----------------------------------------------------------------------------------------------------------</span><br><span class="line">前言 “周志华老师的《机器学习》（西瓜书）是机器学习领域的经典入门教材之一，周老师为了使尽可 </span><br><span class="line">能多的读 者通过西瓜书对机器学习有所了解, 所以在书中对部分公式的推导细节没有详述，但是这对那</span><br><span class="line">些想深究公式推 导细节的读者来说可能“不太友好”，本书旨在对西瓜书里比较难理解的公式加以解析，</span><br><span class="line">以及对部分公式补充 具体的推导细节。” 读到这里，大家可能会疑问为啥前面这段话加了引号，因为这</span><br><span class="line">只是我们最初的遐想，后来我们了解到，周 老师之所以省去这些推导细节的真实原因是，他本尊认为“ </span><br><span class="line">理工科数学基础扎实点的大二下学生应该对西瓜书 中的推导细节无困难吧，要点在书里都有了，略去的</span><br><span class="line">细节应能脑补或做练习”。所以...... 本南瓜书只能算是我 等数学渣渣在自学的时候记下来的笔记，希</span><br><span class="line">望能够帮助大家都成为一名合格的“理工科数学基础扎实点的大二 下学生”。 使用说明 • 南瓜书的所有</span><br><span class="line">内容都是以西瓜书的内容为前置知识进行表述的，所以南瓜书的最佳使用方法是以西瓜书 为主线，遇到</span><br><span class="line">自己推导不出来或者看不懂的公式时再来查阅南瓜书； • 对于初学机器学习的小白，西瓜书第<span class="number">1</span> 章和第</span><br><span class="line"><span class="number">2</span> 章的公式强烈不建议深究，简单过一下即可，等你学得 有点飘的时候再回来啃都来得及； • 每个公 </span><br><span class="line">式的解析和推导我们都力(zhi) 争(neng) 以本科数学基础的视角进行讲解，所以超纲的数学知识 我们 </span><br><span class="line">通常都会以附录和参考文献的形式给出，感兴趣的同学可以继续沿着我们给的资料进行深入学习； • 若</span><br><span class="line">南瓜书里没有你想要查阅的公式，或者你发现南瓜书哪个地方有错误，请毫不犹豫地去我们GitHub 的 I</span><br><span class="line">可以微信联系我们（微信号：at-Sm1les）； 配套视频教程：https://www.bilibili.com/video/BV1Mh411e7VU </span><br><span class="line">在线阅读地址：https://datawhalechina.github.io/pumpkin-book（仅供第<span class="number">1</span> 版） 最新版PDF </span><br><span class="line">获取地址：https://github.com/datawhalechina/pumpkin-book/releases 编委会 </span><br><span class="line">主编：Sm1les、archwalker、jbb0523 编委：juxiao、Majingmin、MrBigFan、shanry、Ye980226 封面设计：构思-Sm1les、</span><br><span class="line">创作-林王茂盛 致谢 特别感谢awyd234、feijuan、Ggmatch、Heitao5200、huaqing89、LongJH、LilRachel、LeoLRH、Nono17、 spareribs、sunchaothu、StevenLzq 在最早期的时候对南瓜书所做的贡献。  </span><br><span class="line">扫描下方二维码，然后回复关键词“南瓜书”，即可加入“南瓜书读者交流群” 版权声明 本作品采用知识 </span><br><span class="line">共享署名-非商业性使用-相同方式共享<span class="number">4.0</span> 国际许可协议进行许可。</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>进一步分析数据，我们发现数据中还有不少的<code>•</code>和空格，我们使用replace方法去掉即可。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pdf_page.page_content = pdf_page.page_content.replace(<span class="string">&quot;•&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">pdf_page.page_content = pdf_page.page_content.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">前言“周志华老师的《机器学习》（西瓜书）是机器学习领域的经典入门教材之一，周老师为了使尽可能</span><br><span class="line">多的读者通过西瓜书对机器学习有所了解,所以在书中对部分公式的推导细节没有详述，但是这对那些想</span><br><span class="line">深究公式推导细节的读者来说可能“不太友好”，本书旨在对西瓜书里比较难理解的公式加以解析，以及 </span><br><span class="line">对部分公式补充具体的推导细节。”读到这里，大家可能会疑问为啥前面这段话加了引号，因为这只是我</span><br><span class="line">们最初的遐想，后来我们了解到，周老师之所以省去这些推导细节的真实原因是，他本尊认为“理工科数</span><br><span class="line">学基础扎实点的大二下学生应该对西瓜书中的推导细节无困难吧，要点在书里都有了，略去的细节应能 </span><br><span class="line">脑补或做练习”。所以......本南瓜书只能算是我等数学渣渣在自学的时候记下来的笔记，希望能够帮助</span><br><span class="line">大家都成为一名合格的“理工科数学基础扎实点的大二下学生”。使用说明南瓜书的所有内容都是以西瓜 </span><br><span class="line">书的内容为前置知识进行表述的，所以南瓜书的最佳使用方法是以西瓜书为主线，遇到自己推导不出来 </span><br><span class="line">或者看不懂的公式时再来查阅南瓜书；对于初学机器学习的小白，西瓜书第<span class="number">1</span>章和第<span class="number">2</span>章的公式强烈不建 </span><br><span class="line">议深究，简单过一下即可，等你学得有点飘的时候再回来啃都来得及；每个公式的解析和推导我们都力(zhi)争(neng)</span><br><span class="line">以本科数学基础的视角进行讲解，所以超纲的数学知识我们通常都会以附录和参考文献的 </span><br><span class="line">形式给出，感兴趣的同学可以继续沿着我们给的资料进行深入学习；若南瓜书里没有你想要查阅的公式 </span><br><span class="line">，或者你发现南瓜书哪个地方有错误，请毫不犹豫地去我们GitHub的Issues（地址：https://github.coes）；</span><br><span class="line">配套视频教程：https://www.bilibili.com/video/BV1Mh411e7VU</span><br><span class="line">在线阅读地址：https://datawhalechina.github.io/pumpkin-book（仅供第<span class="number">1</span>版）最新版PDF获取地址：https://github.com/datawhalechina/pumpkin-book/releases</span><br><span class="line">编委会主编：Sm1les、archwalker、jbb0523编委：juxiao、Majingmin、</span><br><span class="line">MrBigFan、shanry、Ye980226封面设计：构思-Sm1les、创作-林王茂盛致谢特别感谢awyd234、feijuan </span><br><span class="line">、Ggmatch、Heitao5200、huaqing89、LongJH、LilRachel、LeoLRH、Nono17、spareribs、sunchaothu </span><br><span class="line">、StevenLzq在最早期的时候对南瓜书所做的贡献。扫描下方二维码，然后回复关键词“南瓜书”，即可加</span><br><span class="line">入“南瓜书读者交流群”版权声明本作品采用知识共享署名-非商业性使用-相同方式共享<span class="number">4.0</span>国际许可协议</span><br><span class="line">进行许可。</span><br></pre></td></tr></table></figure>



<h2 id="文档分割"><a href="#文档分割" class="headerlink" title="文档分割"></a>文档分割</h2><p><font color = black size = 4>由于单个文档的长度往往会超过模型支持的上下文，导致检索得到的知识太长超出模型的处理能力，因此，在构建向量知识库的过程中，我们往往需要对文档进行分割，将单个文档按长度或者固定的规则分割成若干个chunk，然后每个 chunk 转化为词向量，存储到向量数据库中。</font></p>
<p><font color = black size = 4>在检索时，我们会以 chunk 作为检索的元单位，也就是每一页检索到 k 个 chunk 作为模型可以参考来回答用户问题的知识，这个 k 是我们可以自由设定的</font></p>
<p><font color = black size = 4>Langchain 中文本分割器都根据 <code>chunk_size</code> (块大小)和 <code>chunk_overlap</code> (块与块之间的重叠大小)进行分割。</font></p>
<p><img src="https://raw.githubusercontent.com/phioenx/blog-img/main/blog-img/C3-3-example-splitter.png"></p>
<ul>
<li><font color = black size = 4><code>chunk_size</code> 指每个块包含的字符或Token（如单词、句子等）的数量</font></li>
<li><font color = black size = 4><code>chunk_overlap</code> 指两个块之间共享的字符数量，用于保持上下文的连贯性，避免分割丢失上下文信息</font></li>
</ul>
<p><font color = black size = 4>Langchain 提供多种文档分割方式，区别在怎么确定块与块之间的边界、块由哪些字符&#x2F;token组成、以及如何测量块大小</font></p>
<ul>
<li><font color = black size = 4><strong>RecursiveCharacterTextSplitter():</strong>  按字符串分割文本，递归地尝试按不同的分隔符进行分割文本。</font></li>
<li><font color = black size = 4><strong>CharacterTextSplitter():</strong> 按字符来分割文本。</font></li>
<li><font color = black size = 4><strong>MarkdownHeaderTextSplitter():</strong> 基于指定的标题来分割markdown 文件。</font></li>
<li><font color = black size = 4><strong>TokenTextSplitter():</strong> 按token来分割文本。</font></li>
<li><font color = black size = 4><strong>SentenceTransformersTokenTextSplitter():</strong> 按token来分割文本</font></li>
<li><font color = black size = 4><strong>Language():</strong> 用于 CPP、Python、Ruby、Markdown 等。</font></li>
<li><font color = black size = 4><strong>NLTKTextSplitter():</strong> 使用 NLTK（自然语言工具包）按句子分割文本。</font></li>
<li><font color = black size = 4><strong>SpacyTextSplitter():</strong> 使用 Spacy按句子的切割文本。</font></li>
</ul>
<p><font color = black size = 4>为了便于后续的嵌入和检索，长文档被分割成较小的、可管理的文本块（chunks）。这里采用了递归字符分割策略，使用其默认参数进行分块。当不指定参数初始化 <code>RecursiveCharacterTextSplitter()</code> 时，其默认行为旨在最大程度保留文本的语义结构：</font></p>
<ul>
<li><font color = black size = 4><strong>默认分隔符与语义保留</strong>: 按顺序尝试使用一系列预设的分隔符 <code>[&quot;\n\n&quot; (段落), &quot;\n&quot; (行), &quot; &quot; (空格), &quot;&quot; (字符)]</code> 来递归分割文本。这种策略的目的是尽可能保持段落、句子和单词的完整性，因为它们通常是语义上最相关的文本单元，直到文本块达到目标大小。</font></li>
<li><font color = black size = 4><strong>保留分隔符</strong>: 默认情况下 (<code>keep_separator=True</code>)，分隔符本身会被保留在分割后的文本块中。</font></li>
<li><font color = black size = 4><strong>默认块大小与重叠</strong>: 使用其基类 <code>TextSplitter</code> 中定义的默认参数 <code>chunk_size=4000</code>（块大小）和 <code>chunk_overlap=200</code>（块重叠）。这些参数确保文本块符合预定的大小限制，并通过重叠来减少上下文信息的丢失。</font></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入文本分割器</span></span><br><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 知识库中单段文本长度</span></span><br><span class="line">CHUNK_SIZE = <span class="number">500</span></span><br><span class="line"><span class="comment"># 知识库中相邻文本重合长度</span></span><br><span class="line">OVERLAP_SIZE = <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27; </span></span><br><span class="line"><span class="string">* RecursiveCharacterTextSplitter 递归字符文本分割</span></span><br><span class="line"><span class="string">RecursiveCharacterTextSplitter 将按不同的字符递归地分割(按照这个优先级[&quot;\n\n&quot;, &quot;\n&quot;, &quot; &quot;, &quot;&quot;])，</span></span><br><span class="line"><span class="string">    这样就能尽量把所有和语义相关的内容尽可能长时间地保留在同一位置</span></span><br><span class="line"><span class="string">RecursiveCharacterTextSplitter需要关注的是4个参数：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* separators - 分隔符字符串数组</span></span><br><span class="line"><span class="string">* chunk_size - 每个文档的字符数量限制</span></span><br><span class="line"><span class="string">* chunk_overlap - 两份文档重叠区域的长度</span></span><br><span class="line"><span class="string">* length_function - 长度计算函数</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 使用递归字符文本分割器</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter(</span><br><span class="line">    chunk_size=CHUNK_SIZE,</span><br><span class="line">    chunk_overlap=OVERLAP_SIZE,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">text_splitter.split_text(pdf_page.page_content[<span class="number">0</span>:<span class="number">1000</span>])</span><br><span class="line"></span><br><span class="line">split_docs = text_splitter.split_documents(pdf_pages)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;切分后的文件数量：<span class="subst">&#123;<span class="built_in">len</span>(split_docs)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;切分后的字符数（可以用来大致评估 token 数）：<span class="subst">&#123;<span class="built_in">sum</span>([<span class="built_in">len</span>(doc.page_content) <span class="keyword">for</span> doc <span class="keyword">in</span> split_docs])&#125;</span>&quot;</span>)</span><br><span class="line">-------------------------------------------------------------------------------------------------------</span><br><span class="line">切分后的文件数量：<span class="number">712</span></span><br><span class="line">切分后的字符数（可以用来大致评估 token 数）：<span class="number">305745</span></span><br></pre></td></tr></table></figure>



<h2 id="搭建并使用向量数据库"><a href="#搭建并使用向量数据库" class="headerlink" title="搭建并使用向量数据库"></a>搭建并使用向量数据库</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> PyMuPDFLoader</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> UnstructuredAPIFileIOLoader</span><br><span class="line"><span class="comment"># 导入文本分割器</span></span><br><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取folder_path下所有文件路径，储存在file_paths里</span></span><br><span class="line">file_paths = []</span><br><span class="line">folder_path = <span class="string">&quot;D:\Amadeus\Zeztz-demo1\datas\knowledge_db&quot;</span> </span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(folder_path):</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        file_path = os.path.join(root, file)</span><br><span class="line">        file_paths.append(file_path)</span><br><span class="line"><span class="built_in">print</span>(file_paths)</span><br><span class="line">----------------------------------------------------------------------------------------------------------</span><br><span class="line">[<span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\pumpkin_book.pdf&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 遍历文件路径并把实例化的loader存放在loaders里</span></span><br><span class="line">loaders = []</span><br><span class="line"><span class="keyword">for</span> file_path <span class="keyword">in</span> file_paths:</span><br><span class="line">    <span class="keyword">if</span> file_path.endswith(<span class="string">&#x27;.pdf&#x27;</span>):</span><br><span class="line">        loaders.append(PyMuPDFLoader(file_path))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        loaders.append(UnstructuredAPIFileIOLoader(file_path))</span><br><span class="line"><span class="comment"># 下载文件并存储到text</span></span><br><span class="line">texts = []</span><br><span class="line"><span class="keyword">for</span> loader <span class="keyword">in</span> loaders:</span><br><span class="line">    texts.extend(loader.load())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切分文档</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter(</span><br><span class="line">    chunk_size=<span class="number">500</span>,</span><br><span class="line">    chunk_overlap=<span class="number">50</span>,</span><br><span class="line">)</span><br><span class="line">split_docs = text_splitter.split_documents(texts)</span><br></pre></td></tr></table></figure>



<h2 id="构建Chroma向量库"><a href="#构建Chroma向量库" class="headerlink" title="构建Chroma向量库"></a>构建Chroma向量库</h2><p><font color = black size = 4>Langchain 集成了超过 30 个不同的向量存储库。我们选择 Chroma 是因为它轻量级且数据存储在内存中，这使得它非常容易启动和开始使用。</font></p>
<p><font color = black size = 4>这边使用阿里云所提供的 api 对获取embedding模型进行封装如下：</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.embeddings <span class="keyword">import</span> Embeddings</span><br><span class="line"></span><br><span class="line">api_key=os.getenv(<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>)  <span class="comment"># 如果您没有配置环境变量，请在此处用您的API Key进行替换</span></span><br><span class="line">base_url=<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>  <span class="comment"># 百炼服务的base_url</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TextV4Embeddings</span>(<span class="title class_ inherited__">Embeddings</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用text-embedding-v4模型&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line">        <span class="variable language_">self</span>.client = OpenAI(api_key=api_key,base_url=base_url)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">embed_documents</span>(<span class="params">self, texts: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">float</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成输入文本列表的embedding.</span></span><br><span class="line"><span class="string">            Args: texts(List[str])：要生成embedding的文本列表.</span></span><br><span class="line"><span class="string">            Returns:List[List[float]]：输入列表中每个文档的embedding列表。每个embedding都表示为一个浮点值列表。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        completion = <span class="variable language_">self</span>.client.embeddings.create(</span><br><span class="line">            model=<span class="string">&quot;text-embedding-v4&quot;</span>,</span><br><span class="line">            <span class="built_in">input</span>=texts,</span><br><span class="line">            dimensions=<span class="number">1024</span>,  <span class="comment"># 仅 text-embedding-v3及 text-embedding-v4支持该参数</span></span><br><span class="line">            encoding_format=<span class="string">&quot;float&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [embeddings.embedding <span class="keyword">for</span> embeddings <span class="keyword">in</span> completion.data]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">embed_query</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">list</span>[<span class="built_in">float</span>]:</span><br><span class="line">        completion = <span class="variable language_">self</span>.client.embeddings.create(</span><br><span class="line">            model=<span class="string">&quot;text-embedding-v4&quot;</span>,</span><br><span class="line">            <span class="built_in">input</span>=text,</span><br><span class="line">            dimensions=<span class="number">1024</span>,  <span class="comment"># 仅 text-embedding-v3及 text-embedding-v4支持该参数</span></span><br><span class="line">            encoding_format=<span class="string">&quot;float&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> completion.data[<span class="number">0</span>].embedding</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>然后，使用封装好的嵌入模型去构建Chroma数据库</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> demo_embedding <span class="keyword">import</span> TextV4Embeddings</span><br><span class="line"><span class="comment"># 构建 Chroma 数据库</span></span><br><span class="line"><span class="comment"># 实例化数据库, 为其配置</span></span><br><span class="line">vectordb = Chroma.from_documents(</span><br><span class="line">    documents=split_docs,</span><br><span class="line">    embedding=TextV4Embeddings(),</span><br><span class="line">    persist_directory=<span class="string">&quot;./data_base/vector_db&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询数据库里的数量</span></span><br><span class="line">vectordb._collection.count()</span><br><span class="line"><span class="built_in">print</span>(vectordb._collection.count())</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>创建好以后，可以直接调用已经创建好在本地的知识库：</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> demo_embedding <span class="keyword">import</span> TextV4Embeddings</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> Chroma</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载已保存的Chroma知识库</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_existing_chroma</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;加载本地已保存的Chroma知识库&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 使用与保存时相同的绝对路径</span></span><br><span class="line">    persist_path = os.path.abspath(<span class="string">&quot;./data_base/vector_db&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在加载知识库: <span class="subst">&#123;persist_path&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 直接加载已有的知识库，不需要重新调用from_documents</span></span><br><span class="line">    vectordb = Chroma(</span><br><span class="line">        persist_directory=persist_path,</span><br><span class="line">        embedding_function=TextV4Embeddings()</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证加载是否成功</span></span><br><span class="line">    count = vectordb._collection.count()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;知识库加载成功，包含 <span class="subst">&#123;count&#125;</span> 个文档&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vectordb</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>Chroma的相似度搜索使用的是余弦距离，即：</font></p>
<p><img src="https://raw.githubusercontent.com/phioenx/blog-img/main/blog-img/image-20251222163644172.png"></p>
<p><font color = black size = 4>其中、$a_i、b_i$分别是向量$A$、$B$的分量。</font></p>
<p><font color = black size = 4>当你需要数据库返回严谨的按余弦相似度排序的结果时可以使用<code>similarity_search</code>函数</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用加载的知识库进行向量检索</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_in_chroma</span>(<span class="params">vectordb, query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;在已加载的知识库中进行向量检索&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n正在检索: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进行相似度搜索，返回最相似的3个结果</span></span><br><span class="line">    results = vectordb.similarity_search(</span><br><span class="line">        query=query,</span><br><span class="line">        k=<span class="number">3</span>  <span class="comment"># 返回前3个最相似的结果</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 打印检索结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;找到 <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> 个相似结果:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(results, <span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n结果 <span class="subst">&#123;i&#125;</span>:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;内容: <span class="subst">&#123;result.page_content[:<span class="number">200</span>]&#125;</span>...&quot;</span>)  <span class="comment"># 只显示前200个字符</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;元数据: <span class="subst">&#123;result.metadata&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载已保存的知识库</span></span><br><span class="line">vectordb = load_existing_chroma()</span><br><span class="line">query1 = <span class="string">&quot;什么是大语言模型&quot;</span></span><br><span class="line">search_in_chroma(vectordb, query1)</span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br><span class="line">正在加载知识库: D:\Amadeus\data_base\vector_db</span><br><span class="line">知识库加载成功，包含 <span class="number">1992</span> 个文档</span><br><span class="line"></span><br><span class="line">正在检索: 什么是大语言模型</span><br><span class="line">找到 <span class="number">3</span> 个相似结果:</span><br><span class="line"></span><br><span class="line">结果 <span class="number">1</span>:</span><br><span class="line">内容: 第二章 语言模型，提问范式与 Token</span><br><span class="line"></span><br><span class="line">在本章中，我们将和您分享大型语言模型（LLM）的工作原理、训练方式以及分词器（tokenizer）等细 </span><br><span class="line">节对 LLM 输出的影响。我们还将介绍 LLM 的提问范式（chat <span class="built_in">format</span>），这是一种指定系统消息      </span><br><span class="line">（system message）和用户消息（user message）的方式，让您了解如何利用这种能力。</span><br><span class="line">一、语言模型</span><br><span class="line"></span><br><span class="line">大语言模型（LLM...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">97</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>, <span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">结果 <span class="number">2</span>:</span><br><span class="line">内容: 复训练促使模型参数收敛，使其预测能力不断提高。经过在海量文本数据集上的训练，语言模型 </span><br><span class="line">可以达</span><br><span class="line">到十分准确地预测下一个词的效果。这种以预测下一个词为训练目标的方法使得语言模型获得强大的语 </span><br><span class="line">言生成能力。</span><br><span class="line">大型语言模型主要可以分为两类:基础语言模型和指令调优语言模型。</span><br><span class="line">基础语言模型（Base LLM）通过反复预测下一个词来训练的方式进行训练，没有明确的目标导向。因   </span><br><span class="line">此，如果给它一个开放式的 prompt ...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">97</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">结果 <span class="number">3</span>:</span><br><span class="line">内容: 执行特定的、通常是一次性的任务。但我们认为，对于开发人员，大语言模型（LLM） 的更强大 </span><br><span class="line">功能是</span><br><span class="line">能通过 API 接口调用，从而快速构建软件应用程序。实际上，我们了解到 DeepLearning.AI 的姊妹公 </span><br><span class="line">司</span><br><span class="line">AI Fund 的团队一直在与许多初创公司合作，将这些技术应用于诸多应用程序上。很兴奋能看到 LLM API</span><br><span class="line">能够让开发人员非常快速地构建应用程序。</span><br><span class="line">在本模块，我们将与读者分享提升大语...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>, <span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">9</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>可以使用<code>similarity_search_with_score</code>函数返回相似度分数</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用相似性搜索与分数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_with_score</span>(<span class="params">vectordb, query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;在已加载的知识库中进行向量检索，并返回相似度分数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n正在检索(带分数): <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进行相似度搜索，返回结果和分数</span></span><br><span class="line">    results_with_scores = vectordb.similarity_search_with_score(</span><br><span class="line">        query=query,</span><br><span class="line">        k=<span class="number">3</span>  <span class="comment"># 返回前3个最相似的结果</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 打印检索结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;找到 <span class="subst">&#123;<span class="built_in">len</span>(results_with_scores)&#125;</span> 个相似结果:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, (result, score) <span class="keyword">in</span> <span class="built_in">enumerate</span>(results_with_scores, <span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n结果 <span class="subst">&#123;i&#125;</span> (相似度: <span class="subst">&#123;score:<span class="number">.4</span>f&#125;</span>):&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;内容: <span class="subst">&#123;result.page_content[:<span class="number">200</span>]&#125;</span>...&quot;</span>)  <span class="comment"># 只显示前200个字符</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;元数据: <span class="subst">&#123;result.metadata&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results_with_scores</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 加载已保存的知识库</span></span><br><span class="line">vectordb = load_existing_chroma()</span><br><span class="line">query2 = <span class="string">&quot;微调&quot;</span></span><br><span class="line">search_with_score(vectordb, query2)</span><br><span class="line">---------------------------------------正在加载知识库: D:\Amadeus\data_base\vector_db</span><br><span class="line">知识库加载成功，包含 <span class="number">1992</span> 个文档</span><br><span class="line"></span><br><span class="line">正在检索(带分数): 微调</span><br><span class="line">找到 <span class="number">3</span> 个相似结果:</span><br><span class="line"></span><br><span class="line">结果 <span class="number">1</span> (相似度: <span class="number">0.8100</span>):</span><br><span class="line">内容: 并给出符合指令的回答。例如，对“中国的首都是哪里？”这个问题，经过微调的语言模型很可能 </span><br><span class="line">直接回答</span><br><span class="line">“中国的首都是北京”，而不是生硬地列出一系列相关问题。指令微调使语言模型更加适合任务导向的对 </span><br><span class="line">话</span><br><span class="line">应用。它可以生成遵循指令的语义准确的回复，而非自由联想。因此，许多实际应用已经采用指令调优 </span><br><span class="line">语言模型。熟练掌握指令微调的工作机制，是开发者实现语言模型应用的重要一步。</span><br><span class="line">那么，如何将基础语言模型转变为指令微调语...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">97</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;creationDate&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">结果 <span class="number">2</span> (相似度: <span class="number">0.9288</span>):</span><br><span class="line">内容: 五、在难测试用例上评估修改后的指令</span><br><span class="line"></span><br><span class="line">我们可以在之前表现不如预期的较难测试用例上评估改进后系统的效果：</span><br><span class="line">六、回归测试：验证模型在以前的测试用例上仍然有效</span><br><span class="line"></span><br><span class="line">检查并修复模型以提高难以测试的用例效果，同时确保此修正不会对先前的测试用例性能造成负面影   </span><br><span class="line">响。</span><br><span class="line">    [&#123;<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;电脑和笔记本&#x27;</span>, \</span><br><span class="line"><span class="string">&#x27;products&#x27;</span>: [<span class="string">&#x27;TechPro 超极本&#x27;</span>, <span class="string">&#x27;BlueWave 游戏本&#x27;</span>...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">167</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>, <span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">结果 <span class="number">3</span> (相似度: <span class="number">0.9514</span>):</span><br><span class="line">内容: 图 <span class="number">1.7</span> 温度系数</span><br><span class="line">一般来说，如果需要可预测、可靠的输出，则将 temperature 设置为<span class="number">0</span>，在所有课程中，我们一直设置 </span><br><span class="line">温度为零；如果需要更具创造性的多样文本，那么适当提高 temperature 则很有帮助。调整这个参数可</span><br><span class="line">以灵活地控制语言模型的输出特性。</span><br><span class="line">在下面例子中，针对同一段来信，我们提醒语言模型使用用户来信中的详细信息，并设置一个较高的   </span><br><span class="line">temperature ，运行两次，比较...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">78</span>&#125;--------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>如果只考虑检索出内容的相关性会导致内容过于单一，可能丢失重要信息。</font></p>
<p><font color = black size = 4>最大边际相关性 (<code>MMR, Maximum marginal relevance</code>) 可以帮助我们在保持相关性的同时，增加内容的丰富度。</font></p>
<p><font color = black size = 4>核心思想是在已经选择了一个相关性高的文档之后，再选择一个与已选文档相关性较低但是信息丰富的文档。这样可以在保持相关性的同时，增加内容的多样性，避免过于单一的结果。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用加载的知识库进行向量检索</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_in_mmr</span>(<span class="params">vectordb, query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;在已加载的知识库中进行向量检索&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n正在检索: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进行相似度搜索，返回最相似的3个结果</span></span><br><span class="line">    results = vectordb.max_marginal_relevance_search(</span><br><span class="line">        query=query,</span><br><span class="line">        k=<span class="number">3</span>  <span class="comment"># 返回前3个最相似的结果</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 打印检索结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;找到 <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> 个相似结果:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(results, <span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n结果 <span class="subst">&#123;i&#125;</span>:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;内容: <span class="subst">&#123;result.page_content[:<span class="number">200</span>]&#125;</span>...&quot;</span>)  <span class="comment"># 只显示前200个字符</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;元数据: <span class="subst">&#123;result.metadata&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载已保存的知识库</span></span><br><span class="line">vectordb = load_existing_mmr()</span><br><span class="line">query3 = <span class="string">&quot;什么是大语言模型&quot;</span></span><br><span class="line">search_in_chroma(vectordb, query3)</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">正在加载知识库: D:\Amadeus\data_base\vector_db</span><br><span class="line">知识库加载成功，包含 <span class="number">1992</span> 个文档</span><br><span class="line"></span><br><span class="line">正在检索: 什么是大语言模型</span><br><span class="line">找到 <span class="number">3</span> 个相似结果:</span><br><span class="line"></span><br><span class="line">结果 <span class="number">1</span>:</span><br><span class="line">内容: 第二章 语言模型，提问范式与 Token</span><br><span class="line"></span><br><span class="line">在本章中，我们将和您分享大型语言模型（LLM）的工作原理、训练方式以及分词器（tokenizer）等细</span><br><span class="line">节对 LLM 输出的影响。我们还将介绍 LLM 的提问范式（chat <span class="built_in">format</span>），这是一种指定系统消息     </span><br><span class="line">（system message）和用户消息（user message）的方式，让您了解如何利用这种能力。</span><br><span class="line">一、语言模型</span><br><span class="line"></span><br><span class="line">大语言模型（LLM...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">97</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">结果 <span class="number">2</span>:</span><br><span class="line">内容: 三、局限性</span><br><span class="line"></span><br><span class="line">开发大模型相关应用时请务必铭记：</span><br><span class="line">虚假知识：模型偶尔会生成一些看似真实实则编造的知识</span><br><span class="line">在开发与应用语言模型时，需要注意它们可能生成虚假信息的风险。尽管模型经过大规模预训练，掌握 </span><br><span class="line">了丰富知识，但它实际上并没有完全记住所见的信息，难以准确判断自己的知识边界，可能做出错误推 </span><br><span class="line">断。若让语言模型描述一个不存在的产品,它可能会自行构造出似是而非的细节。这被称为“幻觉”      </span><br><span class="line">(Hallucinati...</span><br><span class="line">元数据: &#123;<span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;PDF 1.7&#x27;</span>, <span class="string">&#x27;file_path&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;creationdate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;creationDate&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;keywords&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;modDate&#x27;</span>: <span class="string">&#x27;D:20230817062022Z&#x27;</span>, <span class="string">&#x27;producer&#x27;</span>: <span class="string">&#x27;iLovePDF&#x27;</span>, <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;total_pages&#x27;</span>: <span class="number">373</span>, <span class="string">&#x27;moddate&#x27;</span>: <span class="string">&#x27;2023-08-17T06:20:22+00:00&#x27;</span>, <span class="string">&#x27;trapped&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">18</span>, <span class="string">&#x27;creator&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;subject&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">结果 <span class="number">3</span>:</span><br><span class="line">内容: 下面是一个使用大语言模型进行语法纠错的简单示例，类似于Grammarly（一个语法纠正和校对的</span><br><span class="line">工</span><br><span class="line">具）的功能。</span><br><span class="line">输入一段关于熊猫玩偶的评价文字，语言模型会自动校对文本中的语法错误，输出修改后的正确版本。 </span><br><span class="line">这里使用的Prompt比较简单直接，只要求进行语法纠正。我们也可以通过扩展Prompt，同时请求语言   </span><br><span class="line">模型调整文本的语气、行文风格等。</span><br><span class="line">text = [</span><br><span class="line">  <span class="string">&quot;The girl with the...</span></span><br><span class="line"><span class="string">元数据: &#123;&#x27;format&#x27;: &#x27;PDF 1.7&#x27;, &#x27;page&#x27;: 66, &#x27;creator&#x27;: &#x27;&#x27;, &#x27;subject&#x27;: &#x27;&#x27;, &#x27;keywords&#x27;: &#x27;&#x27;, &#x27;trapped&#x27;: &#x27;&#x27;, &#x27;creationDate&#x27;: &#x27;&#x27;, &#x27;producer&#x27;: &#x27;iLovePDF&#x27;, &#x27;moddate&#x27;: &#x27;2023-08-17T06:20:22+00:00&#x27;, &#x27;total_pages&#x27;: 373, &#x27;author&#x27;: &#x27;&#x27;, &#x27;file_path&#x27;: &#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;, &#x27;source&#x27;: &#x27;D:\\Amadeus\\Zeztz-demo1\\datas\\knowledge_db\\LLM-v1.0.0.pdf&#x27;, &#x27;creationdate&#x27;: &#x27;&#x27;, &#x27;title&#x27;: &#x27;&#x27;, &#x27;modDate&#x27;: &#x27;D:20230817062022Z&#x27;&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="构建RAG应用"><a href="#构建RAG应用" class="headerlink" title="构建RAG应用"></a>构建RAG应用</h1><h2 id="构建检索问答链"><a href="#构建检索问答链" class="headerlink" title="构建检索问答链"></a>构建检索问答链</h2><p><font color = black size = 4>在上面的章节当中，我们已经介绍了如何根据自己的本地知识文档，搭建一个向量知识库。 在接下来的内容里，我们将使用搭建好的向量数据库，对 query 查询问题进行召回，并将召回结果和 query 结合起来构建 prompt，输入到大模型中进行问答。</font></p>
<p><font color = black size = 4>对于已经加载的向量数据库，我们可以通过<code>as_retriever</code>方法把向量数据库构造成检索器。我们使用一个问题 query 进行向量检索。</font></p>
<p><font color = black size = 4>如下代码会在向量数据库中根据相似性进行检索，返回前k个最相似的文档。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query4 = <span class="string">&quot;微调有哪些方法&quot;</span></span><br><span class="line">retriever = vectordb.as_retriever(search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">3</span>&#125;)</span><br><span class="line">docs = retriever.invoke(query4)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;检索到的内容数：<span class="subst">&#123;<span class="built_in">len</span>(docs)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>打印一下检索到的内容：</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(docs):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;检索到的第<span class="subst">&#123;i&#125;</span>个内容: \n <span class="subst">&#123;doc.page_content&#125;</span>&quot;</span>, end=<span class="string">&quot;\n-----------------------------------------------------\n&quot;</span>)</span><br><span class="line">----------------------------------------------------------------------------------------------------------</span><br><span class="line">检索到的第<span class="number">0</span>个内容:</span><br><span class="line"> 并给出符合指令的回答。例如，对“中国的首都是哪里？”这个问题，经过微调的语言模型很可能直接回</span><br><span class="line">答</span><br><span class="line">“中国的首都是北京”，而不是生硬地列出一系列相关问题。指令微调使语言模型更加适合任务导向的对 </span><br><span class="line">话</span><br><span class="line">应用。它可以生成遵循指令的语义准确的回复，而非自由联想。因此，许多实际应用已经采用指令调优 </span><br><span class="line">语言模型。熟练掌握指令微调的工作机制，是开发者实现语言模型应用的重要一步。</span><br><span class="line">那么，如何将基础语言模型转变为指令微调语言模型呢？</span><br><span class="line">这也就是训练一个指令微调语言模型（例如ChatGPT）的过程。</span><br><span class="line">首先，在大规模文本数据集上进行无监督预训练，获得基础语言模型。这一步需要使用数千亿词甚至更 </span><br><span class="line">多的数据，在大型超级计算系统上可能需要数月时间。</span><br><span class="line">之后，使用包含指令及对应回复示例的小数据集对基础模型进行有监督 fine-tune，这让模型逐步学会 </span><br><span class="line">遵循指令生成输出，可以通过雇佣承包商构造适合的训练示例。</span><br><span class="line">接下来，为了提高语言模型输出的质量，常见的方法是让人类对许多不同输出进行评级，例如是否有   </span><br><span class="line">用、是否真实、是否无害等。</span><br><span class="line">然后，您可以进一步调整语言模型，增加生成高评级输出的概率。这通常使用基于人类反馈的强化学习 </span><br><span class="line">-----------------------------------------------------</span><br><span class="line">检索到的第<span class="number">1</span>个内容:</span><br><span class="line"> 五、在难测试用例上评估修改后的指令</span><br><span class="line"></span><br><span class="line">我们可以在之前表现不如预期的较难测试用例上评估改进后系统的效果：</span><br><span class="line">六、回归测试：验证模型在以前的测试用例上仍然有效</span><br><span class="line"></span><br><span class="line">检查并修复模型以提高难以测试的用例效果，同时确保此修正不会对先前的测试用例性能造成负面影   </span><br><span class="line">响。</span><br><span class="line">    [&#123;<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;电脑和笔记本&#x27;</span>, \</span><br><span class="line"><span class="string">&#x27;products&#x27;</span>: [<span class="string">&#x27;TechPro 超极本&#x27;</span>, <span class="string">&#x27;BlueWave 游戏本&#x27;</span>, <span class="string">&#x27;PowerLite Convertible&#x27;</span>, <span class="string">&#x27;TechPro        </span></span><br><span class="line"><span class="string">Desktop&#x27;</span>, <span class="string">&#x27;BlueWave Chromebook&#x27;</span>]&#125;]</span><br><span class="line">     <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    few_shot_user_2 = &quot;&quot;&quot;</span>我想要最便宜的电脑。你推荐哪款？<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    few_shot_assistant_2 = &quot;&quot;&quot;</span></span><br><span class="line">    [&#123;<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;电脑和笔记本&#x27;</span>, \</span><br><span class="line"><span class="string">&#x27;products&#x27;</span>: [<span class="string">&#x27;TechPro 超极本&#x27;</span>, <span class="string">&#x27;BlueWave 游戏本&#x27;</span>, <span class="string">&#x27;PowerLite Convertible&#x27;</span>, <span class="string">&#x27;TechPro        </span></span><br><span class="line"><span class="string">-----------------------------------------------------</span></span><br><span class="line"><span class="string">检索到的第2个内容:</span></span><br><span class="line"><span class="string"> 图 1.7 温度系数</span></span><br><span class="line"><span class="string">一般来说，如果需要可预测、可靠的输出，则将 temperature 设置为0，在所有课程中，我们一直设置 </span></span><br><span class="line"><span class="string">温度为零；如果需要更具创造性的多样文本，那么适当提高 temperature 则很有帮助。调整这个参数可</span></span><br><span class="line"><span class="string">以灵活地控制语言模型的输出特性。</span></span><br><span class="line"><span class="string">&#x27;</span>products<span class="string">&#x27;: [&#x27;</span>TechPro 超极本<span class="string">&#x27;, &#x27;</span>BlueWave 游戏本<span class="string">&#x27;, &#x27;</span>PowerLite Convertible<span class="string">&#x27;, &#x27;</span>TechPro        </span><br><span class="line">-----------------------------------------------------</span><br><span class="line">检索到的第<span class="number">2</span>个内容:</span><br><span class="line"> 图 <span class="number">1.7</span> 温度系数</span><br><span class="line">一般来说，如果需要可预测、可靠的输出，则将 temperature 设置为<span class="number">0</span>，在所有课程中，我们一直设置 </span><br><span class="line">温度为零；如果需要更具创造性的多样文本，那么适当提高 temperature 则很有帮助。调整这个参数可</span><br><span class="line">以灵活地控制语言模型的输出特性。</span><br><span class="line">温度为零；如果需要更具创造性的多样文本，那么适当提高 temperature 则很有帮助。调整这个参数可</span><br><span class="line">以灵活地控制语言模型的输出特性。</span><br><span class="line">以灵活地控制语言模型的输出特性。</span><br><span class="line">在下面例子中，针对同一段来信，我们提醒语言模型使用用户来信中的详细信息，并设置一个较高的   </span><br><span class="line">temperature ，运行两次，比较他们的结果有何差异。</span><br><span class="line"><span class="comment"># 第一次运行</span></span><br><span class="line">prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">你是一名客户服务的AI助手。</span></span><br><span class="line"><span class="string">你的任务是给一位重要的客户发送邮件回复。</span></span><br><span class="line"><span class="string">根据通过“```”分隔的客户电子邮件生成回复，以感谢客户的评价。</span></span><br><span class="line"><span class="string">如果情感是积极的或中性的，感谢他们的评价。</span></span><br><span class="line"><span class="string">如果情感是消极的，道歉并建议他们联系客户服务。</span></span><br><span class="line"><span class="string">请确保使用评论中的具体细节。</span></span><br><span class="line"><span class="string">以简明和专业的语气写信。</span></span><br><span class="line"><span class="string">以“AI客户代理”的名义签署电子邮件。</span></span><br><span class="line"><span class="string">客户评价：```<span class="subst">&#123;review&#125;</span>```</span></span><br><span class="line"><span class="string">评论情感：<span class="subst">&#123;sentiment&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><font color = black size = 4><strong>创建检索链：</strong></font></p>
<p><font color = black size = 4>将检索到的多个文本块的页面内容 (<code>doc.page_content</code>) 合并成一个单一的字符串，并使用双换行符 (<code>&quot;\n\n&quot;</code>) 分隔各个块，形成最终的上下文信息 (<code>docs_content</code>) 供大语言模型参考。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">combine_docs</span>(<span class="params">docs</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n\n&quot;</span>.join(doc.page_content <span class="keyword">for</span> doc <span class="keyword">in</span> docs)</span><br><span class="line"></span><br><span class="line">combiner = RunnableLambda(combine_docs)</span><br><span class="line">retrieval_chain = retriever | combiner</span><br><span class="line"></span><br><span class="line">retrieval_chain.invoke(<span class="string">&quot;南瓜书是什么？&quot;</span>)</span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="string">&#x27;前言\n“周志华老师的《机器学习》（西瓜书）是机器学习领域的经典入门教材之一，周老师为了使尽可能多的读\n者通过西瓜书对机器学习有所了解, 所以在书中对部分公式的推导细节没有详述，但是这对那些想深究公式推\n导细节的读者来说可能“不太友好”，本书旨在对西瓜书里比较难理解的公式加以解析，以及对部分公式补充\n具体的推导细节。”\n读到这里，大家可能会疑问为啥前面这段话加了引号，因为这只是我们最初的遐想，后来我们了解到，周\n老师之所以省去这些推导细节的真实原因是，他本尊认为“理工科数学基础扎实点的大二下学生应该对西瓜书\n中的推导细节无困难吧，要点在书里都有了，略去的细节应能脑补或做练习”。所以...... 本南瓜书只能算是我\n等数学渣渣在自学的时候记下来的笔记，希望能够帮助大家都成为一名合格的“理工科数学基础扎实点的大二\n下学生”。\n使用说明\n• 南瓜书的所有内容都是以西瓜书的内容为前置知识进行表述的，所以南瓜书的最佳使用方法是以西瓜书\n为主线，遇到自己推导不出来或者看不懂的公式时再来查阅南瓜书；\n• 对于初学机器学习的小白，西瓜书第1 章和第2 章的公式强烈不建议深究，简单过一下即可，等你学得\n\n最新版PDF 获取地址：https://github.com/datawhalechina/pumpkin-book/releases\n编委会\n主编：Sm1les、archwalker、jbb0523\n编委：juxiao、Majingmin、MrBigFan、shanry、Ye980226\n封面设计：构思-Sm1les、创作-林王茂盛\n致谢\n特别感谢awyd234、feijuan、Ggmatch、Heitao5200、huaqing89、LongJH、LilRachel、LeoLRH、Nono17、\nspareribs、sunchaothu、StevenLzq 在最早期的时候对南瓜书所做的贡献。\n扫描下方二维码，然后回复关键词“南瓜书”，即可加入“南瓜书读者交流群”\n版权声明\n本作品采用知识共享署名-非商业性使用-相同方式共享4.0 国际许可协议进行许可。\n\n• 对于初学机器学习的小白，西瓜书第1 章和第2 章的公式强烈不建议深究，简单过一下即可，等你学得\n有点飘的时候再回来啃都来得及；\n• 每个公式的解析和推导我们都力(zhi) 争(neng) 以本科数学基础的视角进行讲解，所以超纲的数学知识\n我们通常都会以附录和参考文献的形式给出，感兴趣的同学可以继续沿着我们给的资料进行深入学习；\n• 若南瓜书里没有你想要查阅的公式，或者你发现南瓜书哪个地方有错误，请毫不犹豫地去我们GitHub 的\nIssues（地址：https://github.com/datawhalechina/pumpkin-book/issues）进行反馈，在对应版块\n提交你希望补充的公式编号或者勘误信息，我们通常会在24 小时以内给您回复，超过24 小时未回复的\n话可以微信联系我们（微信号：at-Sm1les）；\n配套视频教程：https://www.bilibili.com/video/BV1Mh411e7VU\n在线阅读地址：https://datawhalechina.github.io/pumpkin-book（仅供第1 版）&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><font size = 4>使用 <code>&quot;\n\n&quot;</code> (双换行符) 而不是 <code>&quot;\n&quot;</code> (单换行符) 来连接不同的检索文档块，主要是为了在传递给大型语言模型（LLM）时，能够更清晰地在语义上区分这些独立的文本片段。双换行符通常代表段落的结束和新段落的开始，这种格式有助于LLM将每个块视为一个独立的上下文来源，从而更好地理解和利用这些信息来生成回答。</font></p>
</blockquote>
<p><font color = black size = 4>LCEL中要求所有的组成元素都是<code>Runnable</code>类型，前面我们见过的<code>ChatModel</code>、<code>PromptTemplate</code>等都是继承自<code>Runnable</code>类。上方的<code>retrieval_chain</code>是由检索器<code>retriever</code>及组合器<code>combiner</code>组成的，由<code>|</code>符号串连，数据从左向右传递，即问题先被<code>retriever</code>检索得到检索结果，再被<code>combiner</code>进一步处理并输出。</font></p>
<p><font color = black size = 4><strong>创建LLM:</strong></font></p>
<p><font color = black size = 4>在这里，我们调用 阿里云 的 API 创建一个LLM，当然你也可以使用其他 LLM 的API 进行创建。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    api_key=<span class="string">&quot;aliyun_api_key&quot;</span>,</span><br><span class="line">    model_name=<span class="string">&quot;qwen3-max&quot;</span>,</span><br><span class="line">    base_url=<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(llm.invoke(<span class="string">&quot;你好&quot;</span>).content)</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4><strong>构建检索问答链：</strong></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough, RunnableParallel</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;使用以下上下文来回答最后的问题。如果你不知道答案，就说你不知道，不要试图编造答</span></span><br><span class="line"><span class="string">案。最多使用三句话。尽量使答案简明扼要。请你在回答的最后说“谢谢你的提问！”。</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string">问题: &#123;input&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 将template通过 PromptTemplate 转为可以在LCEL中使用的类型</span></span><br><span class="line">prompt = PromptTemplate(template=template)</span><br><span class="line"></span><br><span class="line">qa_chain = (</span><br><span class="line">    RunnableParallel(&#123;<span class="string">&quot;context&quot;</span>: retrieval_chain, <span class="string">&quot;input&quot;</span>: RunnablePassthrough()&#125;)</span><br><span class="line">    | prompt</span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>在上边代码中我们把刚才定义的检索链当作子链作为<code>prompt</code>的<code>context</code>，再使用<code>RunnablePassthrough</code>存储用户的问题作为<code>prompt</code>的<code>input</code>。又因为这两个操作是并行的，所以我们使用<code>RunnableParallel</code>来将他们并行运行。</font></p>
<p><font color = black size = 4>检索问答链效果测试：</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">question_1 = <span class="string">&quot;什么是判别式模型？&quot;</span></span><br><span class="line"></span><br><span class="line">result = qa_chain.invoke(question_1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;大模型+知识库后回答 question_1 的结果：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------------------------\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;大模型自己的回答question_1：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(llm.invoke(question_1).content)</span><br><span class="line">----------------------------------------------------------------------------------------------------------</span><br><span class="line">大模型+知识库后回答 question_1 的结果：</span><br><span class="line">判别式模型是直接求解条件概率 \( P(y|x) \) 的模型，即在已知输入特征 \( x \) 的条件下预测输出</span><br><span class="line">变量 \( y \)。它不关心样本的联合分布，而是专注于区分不同类别的边界。常见的判别式模型包括对 </span><br><span class="line">数几率回归、支持向量机等。</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">大模型自己的回答question_1：</span><br><span class="line">**判别式模型**（Discriminative Model）是机器学习中的一类模型，其主要目标是直接对**条件概率 </span><br><span class="line">分布 \( P(y|x) \)** 建模，即在给定输入 \( x \) 的情况下预测输出 \( y \)。换句话说，判别式模</span><br><span class="line">型关注的是“在看到输入数据后，如何最好地区分或判断其所属类别”。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 核心思想</span></span><br><span class="line">判别式模型不关心数据是如何生成的，它不建模输入 \( x \) 的分布，而是专注于学习输入与输出之间</span><br><span class="line">的边界或映射关系。</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment">### 举例说明</span></span><br><span class="line">假设我们要做图像分类：判断一张图片是猫还是狗。</span><br><span class="line"></span><br><span class="line">- 判别式模型会直接学习：</span><br><span class="line">  “给定这张图片的像素值，它是猫的概率是多少？”</span><br><span class="line">  即建模 \( P(\text&#123;类别&#125; | \text&#123;图像&#125;) \)</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment">### 常见的判别式模型包括：</span></span><br><span class="line"><span class="number">1.</span> **逻辑回归**（Logistic Regression）</span><br><span class="line"><span class="number">2.</span> **支持向量机**（SVM）</span><br><span class="line"><span class="number">3.</span> **神经网络**（Neural Networks）</span><br><span class="line"><span class="number">4.</span> **条件随机场**（CRF）</span><br><span class="line"><span class="number">5.</span> **决策树、随机森林、梯度提升树**（如 XGBoost）</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment">### 判别式 vs 生成式模型（对比）</span></span><br><span class="line">| 特性 | 判别式模型 | 生成式模型 |</span><br><span class="line">|------|------------|-------------|</span><br><span class="line">| 建模目标 | \( P(y|x) \) | \( P(x, y) = P(x|y)P(y) \) |</span><br><span class="line">| 是否建模输入分布 | 否 | 是（建模 \( P(x|y) \)） |</span><br><span class="line">| 关注点 | 决策边界 | 数据生成过程 |</span><br><span class="line">| 典型例子 | SVM, Logistic Regression | 朴素贝叶斯、高斯混合模型、HMM |</span><br><span class="line">| 训练效率 | 通常更高 | 可能更复杂 |</span><br><span class="line">| 所需数据量 | 相对较少 | 通常需要更多数据 |</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment">### 优点</span></span><br><span class="line">- 通常在分类任务上表现更好，尤其是在有大量数据时。</span><br><span class="line">- 更直接地优化分类性能。</span><br><span class="line">- 模型结构相对简单，训练效率高。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 缺点</span></span><br><span class="line">- 无法生成新的数据样本（因为没有建模 \( P(x|y) \)）。</span><br><span class="line">- 对异常值或未见过的数据类型鲁棒性可能较差。</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment">### 总结</span></span><br><span class="line">判别式模型是一种“知其然，不必知其所以然”的方法——它不关心数据是怎么来的，只关心如何根据输入 </span><br><span class="line">做出最准确的判断。因此，在大多数监督学习任务（如分类、回归）中，判别式模型被广泛使用。  </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">question_2 = <span class="string">&quot;Inception是什么&quot;</span></span><br><span class="line"></span><br><span class="line">result = qa_chain.invoke(question_2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;大模型+知识库后回答 question_2 的结果：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------------------------\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;大模型自己的回答question_2：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(llm.invoke(question_2).content)</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">大模型+知识库后回答 question_2 的结果：</span><br><span class="line">Inception 是一种深度卷积神经网络架构，其核心思想是使用 Inception 模块——在一个层中并行使用多种尺寸的卷积（如 <span class="number">1</span>×<span class="number">1</span>、<span class="number">3</span>×<span class="number">3</span>、<span class="number">5</span>×<span class="number">5</span>）和池化操作，然后将结果拼接在一起。这种设计可以提高模型的表达能力，同时通过 <span class="number">1</span>×<span class="number">1</span> 卷积减少计算量。Inception V3 是该系列中的一个经典版本，常用于图 像分类和 DeepDream 等任务。</span><br><span class="line">大模型自己的回答question_2：</span><br><span class="line">“Inception”（中文常译为《盗梦空间》）是由克里斯托弗·诺兰（Christopher Nolan）执导、编剧并监制的一部科幻悬疑电影，于<span class="number">2010</span>年上映。影片融合了动作、心理、哲学与视觉特效等多种元素，因其复杂的叙事结构和对梦境与现实界限的探讨而广受赞誉。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 剧情简介：</span></span><br><span class="line">影片讲述了一群“盗梦者”（Extractors）通过进入他人梦境来窃取潜意识中的秘密。主角多米尼克·柯布（由莱昂纳多·迪卡普里奥饰演）是一位技艺高 超的盗梦者，但因被指控谋杀妻子而流亡海外。他获得了一个看似不可能完成的任务：不是窃取思想，而是“植入”一个想法（即“inception”，意为“植 入”或“开端”）。如果成功，他将能洗清罪名，重返家园。</span><br><span class="line"></span><br><span class="line">为了完成任务，柯布组建了一支专业团队，深入目标人物罗伯特·费舍尔的多层梦境中，逐层构建梦境世界。然而，随着梦境层数加深，现实与幻想的界限逐渐模糊，柯布也必须面对自己内心深处关于亡妻玛尔（Mal）的执念与愧疚。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 核心概念：</span></span><br><span class="line">- **梦境共享**：通过特殊设备，多人可以进入同一个梦境。</span><br><span class="line">- **梦境层级**：梦境可以嵌套，形成“梦中梦”，甚至多层嵌套。</span><br><span class="line">- **时间膨胀**：越深的梦境，时间流逝越慢（例如现实中<span class="number">5</span>分钟，第一层梦境可能是<span class="number">1</span>小时，第二层是数天等）。</span><br><span class="line">- **图腾（Totem）**：每个盗梦者都有一个私密物品，用于判断自己是否处于梦境中（如柯布的陀螺）。</span><br><span class="line">- **潜意识防御**：梦境中的潜意识会以武装投影等形式攻击入侵者。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 主题与哲学思考：</span></span><br><span class="line">- 现实与虚幻的界限</span><br><span class="line">- 记忆、悔恨与救赎</span><br><span class="line">- 意识的可塑性与思想的植入</span><br><span class="line">- 自我欺骗与执念</span><br><span class="line"></span><br><span class="line"><span class="comment">### 影响与评价：</span></span><br><span class="line">- 《Inception》获得了广泛好评，全球票房超过<span class="number">8</span>亿美元。</span><br><span class="line">- 获得第<span class="number">83</span>届奥斯卡金像奖最佳摄影、最佳音效剪辑、最佳混音和最佳视觉效果四项大奖。</span><br><span class="line">- 其开放式结局（陀螺是否停下）引发大量讨论，成为影史经典谜题之一。</span><br><span class="line"></span><br><span class="line">此外，“Inception”一词本身在英语中意为“开始”或“起源”，在电影中特指“在他人潜意识中植入一个想法”的行为，这也是全片的核心设定。</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4><strong>向检索链添加聊天记录：</strong></font></p>
<p><font color = black size = 4>现在我们已经实现了通过上传本地知识文档，然后将他们保存到向量知识库，通过将查询问题与向量知识库的召回结果进行结合输入到 LLM 中，我们就得到了一个相比于直接让 LLM 回答要好得多的结果。在与语言模型交互时，你可能已经注意到一个关键问题 - <strong>它们并不记得你之前的交流内容</strong>。这在我们构建一些应用程序（如聊天机器人）的时候，带来了很大的挑战，使得对话似乎缺乏真正的连续性。这个问题该如何解决呢？</font></p>
<p><font color = black size = 4>在本节中我们将使用 LangChain 中的<code>ChatPromptTemplate</code>，即将先前的对话嵌入到语言模型中，使其具有连续对话的能力。 <code>ChatPromptTemplate</code>可以接收聊天消息历史记录，这些历史记录将在回答问题时与问题一起传递给聊天机器人，从而将它们添加到上下文中。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问答链的系统prompt</span></span><br><span class="line">system_prompt = (</span><br><span class="line">    <span class="string">&quot;你是一个问答任务的助手。 &quot;</span></span><br><span class="line">    <span class="string">&quot;请使用检索到的上下文片段回答这个问题。 &quot;</span></span><br><span class="line">    <span class="string">&quot;如果你不知道答案就说不知道。 &quot;</span></span><br><span class="line">    <span class="string">&quot;请使用简洁的话语回答用户。&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n&quot;</span></span><br><span class="line">    <span class="string">&quot;&#123;context&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># 制定prompt template</span></span><br><span class="line">qa_prompt = ChatPromptTemplate(</span><br><span class="line">    [</span><br><span class="line">        (<span class="string">&quot;system&quot;</span>, system_prompt),</span><br><span class="line">        (<span class="string">&quot;placeholder&quot;</span>, <span class="string">&quot;&#123;chat_history&#125;&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无历史记录</span></span><br><span class="line">messages = qa_prompt.invoke(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;input&quot;</span>: <span class="string">&quot;南瓜书是什么？&quot;</span>,</span><br><span class="line">        <span class="string">&quot;chat_history&quot;</span>: [],</span><br><span class="line">        <span class="string">&quot;context&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> messages.messages:</span><br><span class="line">    <span class="built_in">print</span>(message.content)</span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br><span class="line">你是一个问答任务的助手。 请使用检索到的上下文片段回答这个问题。 如果你不知道答案就说不知道。 请使用简洁的话语回答用户。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">南瓜书是什么？</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有历史记录</span></span><br><span class="line">messages = qa_prompt.invoke(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;input&quot;</span>: <span class="string">&quot;你可以介绍一下他吗？&quot;</span>,</span><br><span class="line">        <span class="string">&quot;chat_history&quot;</span>: [</span><br><span class="line">            (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;西瓜书是什么？&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;ai&quot;</span>, <span class="string">&quot;西瓜书是指周志华老师的《机器学习》一书，是机器学习领域的经典入门教材之一。&quot;</span>),</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;context&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> messages.messages:</span><br><span class="line">    <span class="built_in">print</span>(message.content)</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">你是一个问答任务的助手。 请使用检索到的上下文片段回答这个问题。 如果你不知道答案就说不知道。 请使用简洁的话语回答用户。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">西瓜书是什么？</span><br><span class="line">西瓜书是指周志华老师的《机器学习》一书，是机器学习领域的经典入门教材之一。</span><br><span class="line">你可以介绍一下他吗？</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4><strong>带有信息压缩的检索链：</strong></font></p>
<p><font color = black size = 4>因为我们正在搭建的问答链带有支持多轮对话功能，所以与单轮对话的问答链相比会多面临像上方输出结果的问题，即用户最新的对话语义不全，在使用用户问题查询向量数据库时很难检索到相关信息。像上方的“你可以介绍一下他吗？”，其实是“你可以介绍下周志华老师吗？”的意思。为了解决这个问题我们将采取信息压缩的方式，让llm根据历史记录完善用户的问题。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableBranch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩问题的系统 prompt</span></span><br><span class="line">condense_question_system_template = (</span><br><span class="line">    <span class="string">&quot;请根据聊天记录完善用户最新的问题，&quot;</span></span><br><span class="line">    <span class="string">&quot;如果用户最新的问题不需要完善则返回用户的问题。&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="comment"># 构造 压缩问题的 prompt template</span></span><br><span class="line">condense_question_prompt = ChatPromptTemplate([</span><br><span class="line">        (<span class="string">&quot;system&quot;</span>, condense_question_system_template),</span><br><span class="line">        (<span class="string">&quot;placeholder&quot;</span>, <span class="string">&quot;&#123;chat_history&#125;&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">    ])</span><br><span class="line"><span class="comment"># 构造检索文档的链</span></span><br><span class="line"><span class="comment"># RunnableBranch 会根据条件选择要运行的分支</span></span><br><span class="line">retrieve_docs = RunnableBranch(</span><br><span class="line">    <span class="comment"># 分支 1: 若聊天记录中没有 chat_history 则直接使用用户问题查询向量数据库</span></span><br><span class="line">    (<span class="keyword">lambda</span> x: <span class="keyword">not</span> x.get(<span class="string">&quot;chat_history&quot;</span>, <span class="literal">False</span>), (<span class="keyword">lambda</span> x: x[<span class="string">&quot;input&quot;</span>]) | retriever, ),</span><br><span class="line">    <span class="comment"># 分支 2 : 若聊天记录中有 chat_history 则先让 llm 根据聊天记录完善问题再查询向量数据库</span></span><br><span class="line">    condense_question_prompt | llm | StrOutputParser() | retriever,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4><strong>支持聊天记录的检索问答链</strong></font></p>
<p><font color = black size = 4>这里我们使用之前定义的问答模板即<code>qa_prompt</code>构造问答链，另外我们通过<code>RunnablePassthrough.assign</code>将中间的查询结果存为<code>&quot;context&quot;</code>，将最终结果存为<code>&quot;answer&quot;</code>。因为查询结果被存为<code>&quot;context&quot;</code>，所以我们整合查询结果的函数<code>combine_docs</code>也要做相应的改动。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新定义 combine_docs</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">combine_docs</span>(<span class="params">docs</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n\n&quot;</span>.join(doc.page_content <span class="keyword">for</span> doc <span class="keyword">in</span> docs[<span class="string">&quot;context&quot;</span>]) <span class="comment"># 将 docs 改为 docs[&quot;context&quot;]</span></span><br><span class="line"><span class="comment"># 定义问答链</span></span><br><span class="line">qa_chain = (</span><br><span class="line">    RunnablePassthrough.assign(context=combine_docs) <span class="comment"># 使用 combine_docs 函数整合 qa_prompt 中的 context</span></span><br><span class="line">    | qa_prompt <span class="comment"># 问答模板</span></span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser() <span class="comment"># 规定输出的格式为 str</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># 定义带有历史记录的问答链</span></span><br><span class="line">qa_history_chain = RunnablePassthrough.assign(</span><br><span class="line">    context = (<span class="keyword">lambda</span> x: x) | retrieve_docs <span class="comment"># 将查询结果存为 content</span></span><br><span class="line">    ).assign(answer=qa_chain) <span class="comment"># 将最终结果存为 answer</span></span><br></pre></td></tr></table></figure>

<p><font color = black size = 4><strong>测试检索问答链</strong></font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不带聊天记录</span></span><br><span class="line">qa_history_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;西瓜书是什么？&quot;</span>,</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: []</span><br><span class="line">&#125;)</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">西瓜书是周志华老师所著的《机器学习》一书的昵称，它是机器学习领域的经典入门教材之一。</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 带聊天记录</span></span><br><span class="line">qa_history_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;南瓜书跟它有什么关系？&quot;</span>,</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: [</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;西瓜书是什么？&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;ai&quot;</span>, <span class="string">&quot;西瓜书是指周志华老师的《机器学习》一书，是机器学习领域的经典入门教材之一。&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line">--------------------------------------------------------------------------------------------------------</span><br><span class="line">南瓜书是《机器学习公式详解》的别称，它是对周志华老师《机器学习》（西瓜书）中公式推导的补充</span><br><span class="line">和解析，旨在帮助读者理解西瓜书中省略的数学细节。南瓜书以西瓜书的内容为基础，为初学者提供更 </span><br><span class="line">详细的公式推导过程，适合在阅读西瓜书遇到困难时对照学习。</span><br></pre></td></tr></table></figure>

<p><font color = black size = 4>可以看到，LLM 准确地判断了“它”是什么，代表着我们成功地传递给了它历史信息。另外召回的内容也有着问题的答案，证明我们的信息压缩策略也起到了作用。这种关联前后问题及压缩信息并检索的能力，可大大增强问答系统的连续性和智能水平。</font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
<p><font color = black size = 4></font></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://amadeuspjq.cn">PhoenixPeng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://amadeuspjq.cn/posts/c976db60.html">https://amadeuspjq.cn/posts/c976db60.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://amadeuspjq.cn" target="_blank">哈基鹏的博客🐦</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/cover11.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/3e1df323.html" title="哈基鹏的大模型之旅（八）"><img class="cover" src="/img/cover12.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">哈基鹏的大模型之旅（八）</div></div><div class="info-2"><div class="info-item-1">大模型蒸馏</div></div></div></a><a class="pagination-related" href="/posts/6ae37fcf.html" title="哈基鹏的HTML之路"><img class="cover" src="/img/cover10.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">哈基鹏的HTML之路</div></div><div class="info-2"><div class="info-item-1">在设计智能体工作流的时候，有时候不得不把模型结果输出为pdf格式，这种过程通常需要先把模型转换为HTML进行过渡，由此不得不学习一下HTML的相关知识，因此本文章的内容主要是为了学习HTML的相关知识，以更好的设计网页样式。</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">PhoenixPeng</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/phioenx" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到哈基鹏的小站</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RAG%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">RAG的基本原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%90%91%E9%87%8F%E7%9F%A5%E8%AF%86%E5%BA%93"><span class="toc-number">2.</span> <span class="toc-text">搭建向量知识库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%91%E9%87%8F%E5%8F%8A%E5%90%91%E9%87%8F%E7%9F%A5%E8%AF%86%E5%BA%93"><span class="toc-number">2.1.</span> <span class="toc-text">向量及向量知识库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">数据处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97"><span class="toc-number">2.3.</span> <span class="toc-text">数据清洗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%88%86%E5%89%B2"><span class="toc-number">2.4.</span> <span class="toc-text">文档分割</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.5.</span> <span class="toc-text">搭建并使用向量数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BAChroma%E5%90%91%E9%87%8F%E5%BA%93"><span class="toc-number">2.6.</span> <span class="toc-text">构建Chroma向量库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%84%E5%BB%BARAG%E5%BA%94%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">构建RAG应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%A3%80%E7%B4%A2%E9%97%AE%E7%AD%94%E9%93%BE"><span class="toc-number">3.1.</span> <span class="toc-text">构建检索问答链</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/44d0d27c.html" title="哈基鹏的大模型之旅（九）"><img src="/img/cover13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="哈基鹏的大模型之旅（九）"/></a><div class="content"><a class="title" href="/posts/44d0d27c.html" title="哈基鹏的大模型之旅（九）">哈基鹏的大模型之旅（九）</a><time datetime="2025-12-26T01:39:44.000Z" title="发表于 2025-12-26 09:39:44">2025-12-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3e1df323.html" title="哈基鹏的大模型之旅（八）"><img src="/img/cover12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="哈基鹏的大模型之旅（八）"/></a><div class="content"><a class="title" href="/posts/3e1df323.html" title="哈基鹏的大模型之旅（八）">哈基鹏的大模型之旅（八）</a><time datetime="2025-12-25T01:38:47.000Z" title="发表于 2025-12-25 09:38:47">2025-12-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c976db60.html" title="哈基鹏的大模型之旅（七）"><img src="/img/cover11.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="哈基鹏的大模型之旅（七）"/></a><div class="content"><a class="title" href="/posts/c976db60.html" title="哈基鹏的大模型之旅（七）">哈基鹏的大模型之旅（七）</a><time datetime="2025-12-22T01:38:46.000Z" title="发表于 2025-12-22 09:38:46">2025-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/6ae37fcf.html" title="哈基鹏的HTML之路"><img src="/img/cover10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="哈基鹏的HTML之路"/></a><div class="content"><a class="title" href="/posts/6ae37fcf.html" title="哈基鹏的HTML之路">哈基鹏的HTML之路</a><time datetime="2025-12-10T03:11:15.000Z" title="发表于 2025-12-10 11:11:15">2025-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8390d872.html" title="哈基鹏的智能体实战（二）"><img src="/img/cover9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="哈基鹏的智能体实战（二）"/></a><div class="content"><a class="title" href="/posts/8390d872.html" title="哈基鹏的智能体实战（二）">哈基鹏的智能体实战（二）</a><time datetime="2025-11-24T02:20:13.000Z" title="发表于 2025-11-24 10:20:13">2025-11-24</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By PhoenixPeng</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        loader: {
          load: [
            // Four font extension packages (optional)
            //- '[tex]/bbm',
            //- '[tex]/bboldx',
            //- '[tex]/dsfont',
            '[tex]/mhchem'
          ],
          paths: {
            'mathjax-newcm': '[mathjax]/../@mathjax/mathjax-newcm-font',

            //- // Four font extension packages (optional)
            //- 'mathjax-bbm-extension': '[mathjax]/../@mathjax/mathjax-bbm-font-extension',
            //- 'mathjax-bboldx-extension': '[mathjax]/../@mathjax/mathjax-bboldx-font-extension',
            //- 'mathjax-dsfont-extension': '[mathjax]/../@mathjax/mathjax-dsfont-font-extension',
            'mathjax-mhchem-extension': '[mathjax]/../@mathjax/mathjax-mhchem-font-extension'
          }
        },
        output: {
          font: 'mathjax-newcm',
        },
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
          packages: {
            '[+]': [
              'mhchem'
            ]
          }
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          menuOptions: {
            settings: {
              enrich: false  // Turn off Braille and voice narration text automatic generation
            }
          },
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax@4.0.0/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script defer data-pjax src="/js/readPercent.js"></script><div class="aplayer no-destroy" data-id="9635013358" data-server="tencent" data-type="playlist" data-fixed="true" data-autoplay="true" data-lrcType="-1"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      false
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://amadeuspjq.cn/categories/butterfly主题魔改/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 哈基鹏の魔改教程 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://amadeuspjq.cn/categories/LLM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 哈基鹏の大模型之路 (9)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://amadeuspjq.cn/categories/智能体实战/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 哈基鹏の智能体开发 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://amadeuspjq.cn/categories/HTML/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 哈基鹏の网页学习 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://amadeuspjq.cn/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_categories_card_injector_config(){
    // 检查容器是否存在
    var parent_div_git = document.getElementById('recent-posts');
    // 如果容器不存在，则动态创建
    if (!parent_div_git) {
      console.warn('butterfly_categories_card: 挂载容器不存在，正在动态创建...');
      // 创建新容器（默认插入到页面主体顶部）
      parent_div_git = document.createElement('div');
      parent_div_git.id = 'recent-posts'; // 赋予配置的ID
      document.querySelector('#page').prepend(parent_div_git); // 插入到 #content-inner 内
    }
    var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 950px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 800px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(/img/cag1.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;/categories/智能体实战/&quot;);" href="javascript:void(0);">智能体实战</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">LLM</span></li><li class="categoryBar-list-item" style="background:url(/img/cag2.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;/categories/HTML/&quot;);" href="javascript:void(0);">HTML</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">butterfly主题魔改</span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;/categories/butterfly主题魔改/&quot;);" href="javascript:void(0);">butterfly主题魔改</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;/categories/LLM/&quot;);" href="javascript:void(0);">LLM</a><span class="categoryBar-list-count">9</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
    console.log('已挂载 butterfly_categories_card');
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
  }
  // 路径匹配逻辑（使用 startsWith）
  if (location.pathname.startsWith('/categories/') || '/categories/' === 'all') {
    butterfly_categories_card_injector_config();
  }
  </script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/6ae37fcf.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="/img/cover10.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-12-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/6ae37fcf.html&quot;);" href="javascript:void(0);" alt="">哈基鹏的HTML之路</a><div class="blog-slider__text">在设计智能体工作流的时候，有时候不得不把模型结果输出为pdf格式，这种过程通常需要先把模型转换为HTML进行过渡，由此不得不学习一下HTML的相关知识，因此本文章的内容主要是为了学习HTML的相关知识，以更好的设计网页样式。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/6ae37fcf.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/8390d872.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="/img/cover9.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-11-24</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/8390d872.html&quot;);" href="javascript:void(0);" alt="">哈基鹏的智能体实战（二）</a><div class="blog-slider__text">本文章主要是记录n8n每个节点的用法</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/8390d872.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/7e78e726.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="/img/cover6.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-11-03</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/7e78e726.html&quot;);" href="javascript:void(0);" alt="">哈基鹏的大模型之旅（五）</a><div class="blog-slider__text">大模型压测原理以及实战。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/7e78e726.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ee293f0.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="/img/cover1.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ee293f0.html&quot;);" href="javascript:void(0);" alt="">哈基鹏的butterfly魔改记录</a><div class="blog-slider__text">记录一下魔改butterfly所用的配置的定义以及如何修改，加油把自己的网站变的更加美丽！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ee293f0.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/a6cb3b04.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="/img/cover4.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/a6cb3b04.html&quot;);" href="javascript:void(0);" alt="">哈基鹏的大模型之旅（三）</a><div class="blog-slider__text">简要介绍RAG的定义以及工作流、RAG开发框架LangChain和大模型开发流程。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/a6cb3b04.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><script data-pjax src="https://unpkg.com/oh-my-live2d"></script><script>const oml2d = OML2D.loadOml2d({dockedPosition:"right",mobileDisplay:false,models:[{"path":"/live2d-models/umaru/model.json","position":[30,20],"scale":0.15,"stageStyle":{"width":250,"height":250},"mobilePosition":[10,23],"mobileScale":0.1,"mobileStageStyle":{"width":180,"height":166},"motionPreloadStrategy":"ALL"},{"path":"/live2d-models/hailunna_4/hailunna_4.model3.json","position":[-50,0],"scale":0.08,"stageStyle":{"width":350,"height":350},"mobilePosition":[-10,23],"mobileScale":0.08,"mobileStageStyle":{"width":180,"height":166},"motionPreloadStrategy":"IDLE"}],parentElement:document.body,primaryColor:"var(--btn-bg)",sayHello:false,tips:{style: {"width":230,"height":120,"left":"calc(50% - 20px)","top":"-100px"},mobileStyle: {"width":180,"height":80,"left":"calc(50% - 30px)","top":"-100px"},idleTips:{interval:3600,message:["你好呀，我是哈基鹏~","欢迎来到我的小站~"]}}});</script><!-- hexo injector body_end end --></body></html>